<!DOCTYPE html>
<html>
	<head>
		<title>Horaires</title>
		<link rel="icon" type="image/svg" href="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjZmYwMGY3IiB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHZpZXdCb3g9IjAgMCA2MTAuMzk4IDYxMC4zOTgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iI2ZmMDBmNyI+PGcgaWQ9IlNWR1JlcG9fYmdDYXJyaWVyIiBzdHJva2Utd2lkdGg9IjAiPjwvZz48ZyBpZD0iU1ZHUmVwb190cmFjZXJDYXJyaWVyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjwvZz48ZyBpZD0iU1ZHUmVwb19pY29uQ2FycmllciI+IDxnPiA8Zz4gPHBhdGggZD0iTTE1OS41NjcsMGgtMTUuMzI5Yy0xLjk1NiwwLTMuODExLDAuNDExLTUuNjA4LDAuOTk1Yy04Ljk3OSwyLjkxMi0xNS42MTYsMTIuNDk4LTE1LjYxNiwyMy45OTd2MTAuNTUydjI3LjAwOXYxNC4wNTIgYzAsMi42MTEsMC40MzUsNS4wNzgsMS4wNjYsNy40NGMyLjcwMiwxMC4xNDYsMTAuNjUzLDE3LjU1MiwyMC4xNTgsMTcuNTUyaDE1LjMyOWMxMS43MjQsMCwyMS4yMjQtMTEuMTg4LDIxLjIyNC0yNC45OTJWNjIuNTUzIFYzNS41NDRWMjQuOTkyQzE4MC43OTEsMTEuMTg4LDE3MS4yOTEsMCwxNTkuNTY3LDB6Ij48L3BhdGg+IDxwYXRoIGQ9Ik00NjEuMjg4LDBoLTE1LjMyOWMtMTEuNzI0LDAtMjEuMjI0LDExLjE4OC0yMS4yMjQsMjQuOTkydjEwLjU1MnYyNy4wMDl2MTQuMDUyYzAsMTMuODA0LDkuNSwyNC45OTIsMjEuMjI0LDI0Ljk5MiBoMTUuMzI5YzExLjcyNCwwLDIxLjIyNC0xMS4xODgsMjEuMjI0LTI0Ljk5MlY2Mi41NTNWMzUuNTQ0VjI0Ljk5MkM0ODIuNTA3LDExLjE4OCw0NzMuMDA3LDAsNDYxLjI4OCwweiI+PC9wYXRoPiA8cGF0aCBkPSJNNTM5LjU4Niw2Mi41NTNoLTM3Ljk1NHYxNC4wNTJjMCwyNC4zMjctMTguMTAyLDQ0LjExNy00MC4zNDksNDQuMTE3aC0xNS4zMjljLTIyLjI0NywwLTQwLjM0OS0xOS43OS00MC4zNDktNDQuMTE3IFY2Mi41NTNIMTk5LjkxNnYxNC4wNTJjMCwyNC4zMjctMTguMTAyLDQ0LjExNy00MC4zNDksNDQuMTE3aC0xNS4zMjljLTIyLjI0OCwwLTQwLjM0OS0xOS43OS00MC4zNDktNDQuMTE3VjYyLjU1M0g3MC44MTggYy0yMS4wNjYsMC0zOC4xNSwxNi4wMTctMzguMTUsMzUuNzY0djQ3Ni4zMThjMCwxOS43ODQsMTcuMDgzLDM1Ljc2NCwzOC4xNSwzNS43NjRoNDY4Ljc2M2MyMS4wODUsMCwzOC4xNDktMTUuOTg0LDM4LjE0OS0zNS43NjQgVjk4LjMyMkM1NzcuNzM1LDc4LjU3NSw1NjAuNjcxLDYyLjU1Myw1MzkuNTg2LDYyLjU1M3ogTTUyNy43NTcsNTU3LjlsLTQ0Ni41MDItMC4xNzJWMTczLjcxN2g0NDYuNTAyVjU1Ny45eiI+PC9wYXRoPiA8cGF0aCBkPSJNMzUzLjAxNywyNjYuMjU4aDExNy40MjhjMTAuMTkzLDAsMTguNDM3LTEwLjE3OSwxOC40MzctMjIuNzU5cy04LjI0OC0yMi43NTktMTguNDM3LTIyLjc1OUgzNTMuMDE3IGMtMTAuMTkzLDAtMTguNDM3LDEwLjE3OS0xOC40MzcsMjIuNzU5QzMzNC41OCwyNTYuMDc0LDM0Mi44MjMsMjY2LjI1OCwzNTMuMDE3LDI2Ni4yNTh6Ij48L3BhdGg+IDxwYXRoIGQ9Ik0zNTMuMDE3LDM0OC40NjdoMTE3LjQyOGMxMC4xOTMsMCwxOC40MzctMTAuMTc5LDE4LjQzNy0yMi43NTljMC0xMi41NzktOC4yNDgtMjIuNzU4LTE4LjQzNy0yMi43NThIMzUzLjAxNyBjLTEwLjE5MywwLTE4LjQzNywxMC4xNzktMTguNDM3LDIyLjc1OEMzMzQuNTgsMzM4LjI4OCwzNDIuODIzLDM0OC40NjcsMzUzLjAxNywzNDguNDY3eiI+PC9wYXRoPiA8cGF0aCBkPSJNMzUzLjAxNyw0MzAuNjc2aDExNy40MjhjMTAuMTkzLDAsMTguNDM3LTEwLjE4LDE4LjQzNy0yMi43NTlzLTguMjQ4LTIyLjc1OS0xOC40MzctMjIuNzU5SDM1My4wMTcgYy0xMC4xOTMsMC0xOC40MzcsMTAuMTgtMTguNDM3LDIyLjc1OVMzNDIuODIzLDQzMC42NzYsMzUzLjAxNyw0MzAuNjc2eiI+PC9wYXRoPiA8cGF0aCBkPSJNMzUzLjAxNyw1MTIuODloMTE3LjQyOGMxMC4xOTMsMCwxOC40MzctMTAuMTgsMTguNDM3LTIyLjc1OWMwLTEyLjU4LTguMjQ4LTIyLjc1OS0xOC40MzctMjIuNzU5SDM1My4wMTcgYy0xMC4xOTMsMC0xOC40MzcsMTAuMTc5LTE4LjQzNywyMi43NTlDMzM0LjU4LDUwMi43MSwzNDIuODIzLDUxMi44OSwzNTMuMDE3LDUxMi44OXoiPjwvcGF0aD4gPHBhdGggZD0iTTE0NS4wMzIsMjY2LjI1OEgyNjIuNDZjMTAuMTkzLDAsMTguNDM2LTEwLjE3OSwxOC40MzYtMjIuNzU5cy04LjI0OC0yMi43NTktMTguNDM2LTIyLjc1OUgxNDUuMDMyIGMtMTAuMTk0LDAtMTguNDM3LDEwLjE3OS0xOC40MzcsMjIuNzU5QzEyNi41OTYsMjU2LjA3NCwxMzQuODM4LDI2Ni4yNTgsMTQ1LjAzMiwyNjYuMjU4eiI+PC9wYXRoPiA8cGF0aCBkPSJNMTQ1LjAzMiwzNDguNDY3SDI2Mi40NmMxMC4xOTMsMCwxOC40MzYtMTAuMTc5LDE4LjQzNi0yMi43NTljMC0xMi41NzktOC4yNDgtMjIuNzU4LTE4LjQzNi0yMi43NThIMTQ1LjAzMiBjLTEwLjE5NCwwLTE4LjQzNywxMC4xNzktMTguNDM3LDIyLjc1OEMxMjYuNTk2LDMzOC4yODgsMTM0LjgzOCwzNDguNDY3LDE0NS4wMzIsMzQ4LjQ2N3oiPjwvcGF0aD4gPHBhdGggZD0iTTE0NS4wMzIsNDMwLjY3NkgyNjIuNDZjMTAuMTkzLDAsMTguNDM2LTEwLjE4LDE4LjQzNi0yMi43NTlzLTguMjQ4LTIyLjc1OS0xOC40MzYtMjIuNzU5SDE0NS4wMzIgYy0xMC4xOTQsMC0xOC40MzcsMTAuMTgtMTguNDM3LDIyLjc1OVMxMzQuODM4LDQzMC42NzYsMTQ1LjAzMiw0MzAuNjc2eiI+PC9wYXRoPiA8cGF0aCBkPSJNMTQ1LjAzMiw1MTIuODlIMjYyLjQ2YzEwLjE5MywwLDE4LjQzNi0xMC4xOCwxOC40MzYtMjIuNzU5YzAtMTIuNTgtOC4yNDgtMjIuNzU5LTE4LjQzNi0yMi43NTlIMTQ1LjAzMiBjLTEwLjE5NCwwLTE4LjQzNywxMC4xNzktMTguNDM3LDIyLjc1OUMxMjYuNTk2LDUwMi43MSwxMzQuODM4LDUxMi44OSwxNDUuMDMyLDUxMi44OXoiPjwvcGF0aD4gPC9nPiA8L2c+IDwvZz48L3N2Zz4=">		<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
		
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>
		<style>
			td, th {
				text-align: center;
			}
		</style>		
		<script type="module">
			import {Moment, Timespan, Time } from './moment.js';
			import { InterviewTimeslot, LunchTimeslot, GlobalDebriefingTimeslot, JuryWelcomeTimeslot } from './Timeslot.js';
			import { InterviewerTiming, CandidateTiming, SupervisorTiming } from './Timings.js';


			document.addEventListener("DOMContentLoaded", () => {
				$('#generate').on('click', function () {
					generateTimetable();
				})

				$("#clean").on('click', function(){
					cleanTable();
				})

				document.addEventListener('keydown', (event) => {
					if(event.ctrlKey && event.key == "Enter") {
						$('#generate').click();
					}
				});
				new ClipboardJS('.clippy');
				var date = new Date();
				date.setDate(date.getDate() + 10);
				$('#date')[0].value = date.toISOString().split('T')[0];
				generateTimetable();
			});

			function generateTimetable(){
				const numberOfCandidates = $('#numberOfCandidates')[0].value;
				const candidateNames = $('#candidateNames')[0].value;
				const juryStartTime = Time.Parse($('#juryStartTime')[0].value);
				const welcomeDuration = Timespan.Parse($('#welcomeDuration')[0].value);
				const casusDuration = Timespan.Parse($('#casusDuration')[0].value);
				const correctionDuration = Timespan.Parse($('#correctionDuration')[0].value);
				const meetingDuration = Timespan.Parse($('#meetingDuration')[0].value);
				const debriefDuration = Timespan.Parse($('#debriefDuration')[0].value);
				const lunchTargetTime = Time.Parse($('#lunchTargetTime')[0].value);
				const lunchDuration = Timespan.Parse($('#lunchDuration')[0].value);
				const globalDebriefDuration = Timespan.Parse($('#globalDebriefDuration')[0].value);
				const randomOrder = $('#randomOrder')[0].checked;
			
				const candidates = getCandidates(numberOfCandidates, candidateNames, randomOrder);

				const templateProvider = function(){
					return {
						subject: $('#emailSubject')[0].value,
						body: $('#emailBody')[0].value
					}
				}

				timetable(candidates, juryStartTime, welcomeDuration, casusDuration, correctionDuration, meetingDuration, debriefDuration, lunchTargetTime, lunchDuration, globalDebriefDuration, templateProvider);	
			}

			function getCandidates(number, names, randomOrder){
				if (!names){
					return Array.from({length:number},(v,k) => new Candidate((k+1).toString()));
				} 
				var candidates = names
					.split(/\r?\n/)
					.filter(e => e && e.match(/[A-Za-z]/) !== null)
					.map(a => Candidate.Parse(a));
				return randomOrder
					? candidates.shuffle()
					: candidates;
			}

			Array.prototype.shuffle = function() {
				var array = this;
				var m = array.length, t, i;

				// While there remain elements to shuffle…
				while (m) {

					// Pick a remaining element…
					i = Math.floor(Math.random() * m--);

					// And swap it with the current element.
					t = array[m];
					array[m] = array[i];
					array[i] = t;
				}

				return array;
			}

			class Candidate {
				static Parse(line){
					var parts = line.split(/[\t;]/);

					var emailIndex = -1;

					var email = parts.find((v,i) => {
						if (v.match(/@/)){
							emailIndex = i;
							return true;
						}
						return false;
					})	

					if (emailIndex != -1){
						parts.splice(emailIndex, 1);
					}

					const name = parts.join(' ');

					return new Candidate(name, email);
				}

				constructor(name, email){
					this.name = this.capitalize(name);
					this.email = email;
				}

				toString(){
					return this.name;
				}

				capitalize(value){
					return value.replace(/(^\w{1})|\W+(\w{1})/g, letter => letter.toUpperCase());
				}
			}

			function timetable(candidates, juryStartTime, welcomeDuration, casusDuration, correctionDuration, meetingDuration, debriefDuration, lunchTargetTime, lunchDuration, globalDebriefDuration, templateProvider) {
				cleanTable();
				
				var appearances = [];
				var candidateDuration = welcomeDuration.plus(casusDuration).plus(correctionDuration).plus(meetingDuration);
				var juryDuration = correctionDuration.plus(meetingDuration).plus(debriefDuration);
				var juryWelcomeHappened = false;
				var lunchHappened = false;
				var nextStartTime = juryStartTime.earlier(casusDuration).earlier(welcomeDuration);
				const numberOfCandidates = candidates.length;

				for (var candidate of candidates) {
					var appearance = new InterviewTimeslot(candidate, nextStartTime, welcomeDuration, casusDuration, correctionDuration, meetingDuration, debriefDuration, templateProvider);
					appearances.push(appearance);
					if (!juryWelcomeHappened){
						const juryWelcome = JuryWelcomeTimeslot.ToBeReadyAt(appearance.correctionStartTime);
						appearances.push(juryWelcome);
						juryWelcomeHappened = true;
					}
					
					if (!lunchHappened && appearance.endTime.after(juryDuration.half()).isLaterThan(lunchTargetTime)){
						const lunch = new LunchTimeslot(appearance.endTime, lunchDuration);
						appearances.push(lunch);
						nextStartTime = lunch.endTime.earlier(casusDuration).earlier(welcomeDuration);
						lunchHappened = true;
					} else {
						nextStartTime = appearance.endTime.earlier(casusDuration).earlier(welcomeDuration);
					}

				}

				appearances.push(new GlobalDebriefingTimeslot(appearances.slice(-1)[0].endTime, globalDebriefDuration));

				var date = new Date($('#date')[0].value).toLocaleDateString();
				if (date) {
					$('#timetableTitle')[0].innerText += ` du ${date}`
				}

				if ($('#position')[0].value){
					var position = new Position($('#position')[0].value)
					$('#timetableTitle')[0].innerText += ` pour le poste ${position}`;
				}

				for(const app of appearances){
					$('#result').find('tbody').append(app.summary());
					// $('#resultJury').find('tbody').append(app.interviewerSummary());
					$('#resultCandidates').find('tbody').append(app.candidateSummary());
					$('#resultSupervisor').find('tbody').append(app.supervisorSummary());
				}
				$('#candidateSummary').text(candidateDuration.toString());


			}

			function cleanTable(){
				$('#result').find('tbody').empty();
				// $('#resultJury').find('tbody').empty();
				$('#resultCandidates').find('tbody').empty();
				$('#resultSupervisor').find('tbody').empty();
				$('#timetableTitle')[0].innerText = "Horaire";
			}

			class Position {
				static vowels = ['a','e','i','o','u','y']
				constructor(title){
					this.title = title;
				}

				toString() {
					if (!this.title){
						return ''
					}
					if(Position.vowels.includes(this.title[0].toLocaleLowerCase())){
						return `d'${this.title}`
					}
					return `de ${this.title}`
				}
			}

			
		</script>
	</head>
	<body>
		<div class="container">
			<h1>Entretiens</h1>
			<form class="form-horizontal">
				<div>
					<div class="form-group">
						<div class="col-sm-6">
							<label for="date" class="col-sm-8  control-label">Date du jury</label>
							<div class="col-sm-4"><input id="date" type="date" class="form-control"></div>
							
						</div>
						<div class="col-sm-1">
							<label for="position" class="col-sm-8 control-label">Poste</label>
						</div>
						<div class="col-sm-5">
							<input id="position" type="text" class="form-control">
						</div>	
					</div>

					<div class="form-group">
						<div class="col-sm-6">
							<div class="form-group">
								<label for="numberOfCandidates" class="col-sm-8 control-label"><i class="glyphicon glyphicon-user"></i> Nombre de candidats</label> 
								<div class="col-sm-4"><input id="numberOfCandidates" type="number" class="form-control" value="5"/></div>
							</div>
						</div>
						
						<div class="col-sm-1">Ou</div>
						<div class="col-sm-5">
							<textarea id="candidateNames" class="form-control" placeholder="Un nom de candidat par ligne, par exemple:
John Doe
Jane Doe; Jane.Doe@gmail.com" rows="6" style="resize:none;"></textarea>
							<div class="checkbox">
								<label for="randomOrder">
									<input id="randomOrder" type="checkbox" />
									<i class="glyphicon glyphicon-dice"></i> Ordre aléatoire
								</label> 
							</div>
						</div>
					</div>

					<div class="form-group row">
						<label for="juryStartTime" class="col-sm-4  control-label"> Heure de début pour le jury</label>
						<div class="col-sm-8"><input id="juryStartTime" type="time" step="300" class="form-control" value="09:00"></div>
					</div>

					<div class="form-group row">
						<label for="welcomeDuration" class="col-sm-4  control-label"> Durée de l'accueil</label>
						<div class="col-sm-8"><input id="welcomeDuration" type="time" step="300" class="form-control" value="00:15"></div>
					</div>

					<div class="form-group row">
						<label for="casusDuration" class="col-sm-4  control-label"> Durée du casus</label>
						<div class="col-sm-8"><input id="casusDuration" type="time" step="300" class="form-control" value="01:00"></div>
					</div>
					
					<div class="form-group row">
						<label for="correctionDuration" class="col-sm-4 control-label"> Durée de correction</label>
						<div class="col-sm-8"><input id="correctionDuration" type="time" step="300" class="form-control readonly" value="00:10"></div>
					</div>

					<div class="form-group row">
						<label for="meetingDuration" class="col-sm-4  control-label"> Durée de l'entretien</label>
						<div class="col-sm-8"><input id="meetingDuration" type="time" step="300" class="form-control" value="01:00"></div>
					</div>
					
					<div class="form-group row">
						<label for="debriefDuration" class="col-sm-4  control-label"> Durée du débriefing</label>
						<div class="col-sm-8"><input id="debriefDuration" type="time" step="300" class="form-control readonly" value="00:15"></div>
					</div>
		
					<div class="form-group row">
						<label for="lunchTargetTime" class="col-sm-4  control-label"> Heure ciblée pour la pause</label>
						<div class="col-sm-8"><input id="lunchTargetTime" type="time" step="300" class="form-control readonly" value="12:45"></div>
					</div>

					<div class="form-group row">
						<label for="lunchDuration" class="col-sm-4  control-label"> Durée de la pause midi</label>
						<div class="col-sm-8"><input id="lunchDuration" type="time" step="300" class="form-control readonly" value="00:45"></div>
					</div>

					<div class="form-group row">
						<label for="globalDebriefDuration" class="col-sm-4  control-label"> Durée du débriefing final</label>
						<div class="col-sm-8"><input id="globalDebriefDuration" type="time" step="300" class="form-control readonly" value="00:15"></div>
					</div>
					<div class="form-group row hidden">
						<label for="emailSubject" class="col-sm-4  control-label"> Sujet du mail</label>
						<div class="col-sm-8"><input id="emailSubject" type="text" class="form-control readonly" value="Entretien"></div>
					</div>
					<div class="form-group row hidden">
						<label for="emailBody" class="col-sm-4  control-label"> Corps du mail</label>
						<div class="col-sm-8">
							<textarea id="emailBody" type="text" class="form-control" rows="10">
Cher {candidate.name},

Vous êtes invité à un entretien à {casusStartTime}. Merci d'arriver {welcomeDuration.minute} minutes en avance.

Puisse le sort vous être favorable!</textarea>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-8">
							<button id="generate" type="button" class="btn btn-primary">Générer (Ctrl + Enter)</button>
							<button id="clean" type="button" class="btn btn-warning">Reset</button>
						</div>
					</div>
				</div>
			</form>
			<div class="row">
				<div id="clippy-target">
					<h2 class="clippy" data-clipboard-target="#clippy-target	">
						<i class="glyphicon glyphicon-copy"></i> 
						<span id="timetableTitle">Horaire</span>
					</h2>
					<table id="result" class="table table-striped table-hover ">
						<thead>
							<th>Candidat</th>
							<th>Accueil candidat</th>
							<th>Casus</th>
							<th>Correction du casus</th>
							<th>Entretien</th>
							<th>Délibération</th>
							<th>Confirmé ?</th>
						</thead>
						<tbody>
							
						</tbody>
					</table>
				</div>

				<!-- <h2>Horaire jury</h2>
				<table id="resultJury" class="table">
					<thead>
						<th>Début de la correction</th>
						<th>Début de l'entretien</th>
						<th>Début de la correction</th>
						<th>Fin</th>
					</thead>
					<tbody>
						
					</tbody>
				</table> -->

				<h2>Horaire candidats</h2>
				<table id="resultCandidates" class="table">
					<thead>
						<th>Candidat</th>
						<th>Début du candidat</th>
						<th>Début de la correction</th>
						<th>Début de l'entretien</th>
						<th>Fin</th>
					</thead>
					<tbody>
						
					</tbody>
				</table>

				<h2>Horaire superviseur</h2>
				<table id="resultSupervisor" class="table">
					<thead>
						<th>Candidat</th>
						<th>Début du candidat</th>
						<th>Fin</th>
					</thead>
					<tbody>
						
					</tbody>
				</table>
			</div>
		</div>
	</body>
</html>
