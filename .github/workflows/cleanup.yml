name: Cleanup Preview
on:
  delete:

jobs:
  cleanup:
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Remove Preview and Update Index
        run: |
           git config --global user.name "github-actions[bot]"
           git config --global user.email "github-actions[bot]@users.noreply.github.com"

           # Clone gh-pages
           git clone --branch=gh-pages --depth=1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git public || echo "gh-pages not found"

           if [ -d "public" ]; then
             cd public
             BRANCH_NAME=${{ github.event.ref }}

             if [ -d "previews/$BRANCH_NAME" ]; then
               echo "Deleting preview for $BRANCH_NAME"
               rm -rf "previews/$BRANCH_NAME"

               # Copy script from source (parent dir) to here
               cp ../scripts/generate-dashboard.js .

               # Regenerate index
               node generate-dashboard.js
               rm generate-dashboard.js

               git add .
               git commit -m "Cleanup preview for $BRANCH_NAME"
               git push origin gh-pages
             else
               echo "No preview found for $BRANCH_NAME, skipping."
             fi
           else
             echo "Branch gh-pages does not exist, nothing to clean."
           fi
