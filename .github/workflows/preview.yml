name: Deploy Preview
on:
  push:
    branches-ignore:
      - main
      - gh-pages
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "preview-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install and Build
        run: |
          npm ci
          npm run build
        env:
          PUBLIC_URL: /candidate-schedule/previews/${{ github.ref_name }}

      - name: Deploy Preview and Update Index
        run: |
           # Configure git
           git config --global user.name "github-actions[bot]"
           git config --global user.email "github-actions[bot]@users.noreply.github.com"

           # Clone gh-pages branch
           # We use a token to authenticate
           # Use a separate directory (gh-pages-root) to avoid conflict with source 'public' dir
           git clone --branch=gh-pages --depth=1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-root || (mkdir gh-pages-root && cd gh-pages-root && git init && git checkout -b gh-pages)

           # Prepare destination directory
           mkdir -p gh-pages-root/previews/${{ github.ref_name }}

           # Clean old preview content for this branch (if any) but keep the dir structure
           rm -rf gh-pages-root/previews/${{ github.ref_name }}/*

           # Copy new build artifacts
           cp -r build/* gh-pages-root/previews/${{ github.ref_name }}/

           # Copy generation script to gh-pages root (where it can see previews folder)
           cp scripts/generate-dashboard.js gh-pages-root/

           # Navigate to gh-pages root and generate dashboard
           cd gh-pages-root
           node generate-dashboard.js
           rm generate-dashboard.js

           # Stage changes
           git add .

           # Commit and Push (only if there are changes)
           if ! git diff-index --quiet HEAD; then
             git commit -m "Deploy preview for ${{ github.ref_name }}"
             git push origin gh-pages
           else
             echo "No changes to deploy."
           fi
